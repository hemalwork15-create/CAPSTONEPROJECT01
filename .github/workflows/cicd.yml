name: CI - SAST + DAST

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ----------------------
  # SAST Job
  # ----------------------
  sast:
    name: SAST Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install Bandit (Python SAST tool)
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit scan
        run: bandit -r . -lll -f json -o bandit_report.json

      - name: Upload SAST report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: bandit_report.json

  # ----------------------
  # DAST Job
  # ----------------------
  dast:
    name: DAST Scan
    runs-on: ubuntu-latest
    needs: sast
    services:
      fastapi:
        image: python:3.12-slim
        ports:
          - 8000:8000
        options: >-
          --health-cmd="curl -f http://localhost:8000 || exit 1"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5
        env:
          PYTHONUNBUFFERED: 1
        volumes:
          - .:/app
        command: >
          bash -c "pip install -r /app/requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download SAST report
        uses: actions/download-artifact@v3
        with:
          name: bandit-report
          path: ./reports

      - name: Run OWASP ZAP DAST
        uses: zaproxy/action-full-scan@v1
        with:
          target: 'http://localhost:8000'
          cmd_options: '-t http://localhost:8000 -r dast_report.html'
          rules_file_name: ''
          fail_on_risk: 'Medium'
      
      - name: Upload DAST report
        uses: actions/upload-artifact@v3
        with:
          name: dast-report
          path: dast_report.html
